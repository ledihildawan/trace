<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Grid Architect V73 - Final Kinetic Veil</title>
    <style>
      /* --- DYNAMIC THEME SYSTEM --- */
      :root[data-theme='light'] {
        --bg: #f8fafc;
        --grid-bg: #e2e8f0;
        --border: #cbd5e1;
        --cell-bg: #ffffff;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --accent: #4f46e5;
        --cyan: #0891b2;
        --weekend-bg: #f5f3ff;
        --weekend-text: #7c3aed;
        --today-bg: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
        --month-start-bg: #f0f9ff;
        --filler-bg: #f1f5f9;
        --filler-text: #94a3b8;
      }

      :root[data-theme='dark'] {
        --bg: #020617;
        --grid-bg: #0f172a;
        --border: #1e293b;
        --cell-bg: #020617;
        --text-main: #f1f5f9;
        --text-muted: #475569;
        --accent: #818cf8;
        --cyan: #22d3ee;
        --weekend-bg: #0c0a21;
        --weekend-text: #a78bfa;
        --today-bg: linear-gradient(135deg, #818cf8 0%, #4f46e5 100%);
        --month-start-bg: #082f49;
        --filler-bg: #010413;
        --filler-text: #1e293b;
      }

      /* --- GLOBAL RESET & SMOOTHING --- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100dvh;
        width: 100vw;
        background: var(--bg);
        color: var(--text-main);
        font-family: 'Inter', system-ui, sans-serif;
        overflow: hidden;
        overscroll-behavior: none;
        /* Kita matikan transisi global agar tidak 'bentrok' dengan sistem Veil */
        transition: none;
      }

      /* THE KINETIC VEIL: Tirai Rahasia */
      #theme-veil {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: var(--bg);
        pointer-events: none;
        opacity: 0;
        /* Transisi keluar yang sinematik (lambat di akhir) */
        transition: opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1);
        will-change: opacity;
      }
      #theme-veil.active {
        opacity: 1;
        /* Kecepatan masuk sangat instan (menutup cepat) */
        transition: opacity 0.15s ease-in;
      }

      #viewport {
        width: 100vw;
        height: 100dvh;
        overflow-y: auto;
        scroll-snap-type: y mandatory;
        scrollbar-width: none;
        position: relative;
        transform: translate3d(0, 0, 0);
        &::-webkit-scrollbar {
          display: none;
        }
      }

      #infinite-canvas {
        position: relative;
        width: 100%;
        contain: paints;
      }

      .year-block {
        position: absolute;
        left: 0;
        width: 100vw;
        height: 100dvh;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        display: flex;
        overflow: hidden;
        contain: strict;
      }

      .grid-container {
        position: relative;
        flex: 1;
        display: flex;
        background: var(--bg);
      }

      /* --- WATERMARK & KINETIC GRID --- */
      .watermark-embedded {
        position: absolute;
        top: 0;
        right: 5%;
        height: 100%;
        display: flex;
        align-items: center;
        font-size: clamp(150px, 32dvh, 450px);
        font-weight: 950;
        color: transparent;
        background: linear-gradient(180deg, var(--accent), var(--cyan), transparent);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-stroke: 1px rgba(148, 163, 184, 0.1);
        writing-mode: vertical-rl;
        pointer-events: none;
        z-index: 5;
        white-space: nowrap;
        opacity: 0;
        transform: translate3d(0, 30px, 0);
        transition: opacity 1.2s ease, transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
        .year-block.active & {
          opacity: 0.12;
          transform: translate3d(0, 0, 0);
        }
      }

      .grid-layer {
        position: relative;
        z-index: 2;
        display: grid;
        gap: 1px;
        background: var(--border);
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 0.6s ease;
        .year-block.active & {
          opacity: 1;
        }
      }

      .cell {
        background: var(--cell-bg);
        position: relative;
        opacity: 0;
        transform: translate3d(0, 10px, 0);
        transition: opacity 0.5s ease, transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        .year-block.active & {
          opacity: 1;
          transform: translate3d(0, 0, 0);
        }
        &:nth-child(n + 1) {
          transition-delay: calc(var(--s-idx) * 0.003s);
        }

        &.filler {
          background: var(--filler-bg);
        }
        &.weekend {
          background: var(--weekend-bg);
        }
        &.month-start {
          background: var(--month-start-bg);
          box-shadow: inset 3px 0 0 var(--cyan);
        }
        &.today {
          background: var(--today-bg) !important;
          z-index: 10;
          box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
          .date-num,
          .info-meta {
            color: #fff !important;
          }
        }
      }

      .cell-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        height: 100%;
        padding-block: 10%;
        text-align: center;
      }

      .info-meta {
        font-size: clamp(6px, 0.8dvh, 10px);
        text-transform: uppercase;
        font-weight: 800;
        color: var(--text-muted);
      }
      .date-num {
        font-size: clamp(12px, 2.6dvh, 28px);
        font-weight: 900;
        line-height: 1;
      }
    </style>
  </head>
  <body>
    <div id="theme-veil"></div>

    <main id="viewport">
      <div id="infinite-canvas"></div>
    </main>

    <script type="module">
      /**
       * GridArchitect V73 - Kinetic Veil Edition
       * Definisi akhir untuk performa tinggi dan transisi sinematik.
       */
      class GridArchitect {
        #viewport = document.getElementById('viewport');
        #canvas = document.getElementById('infinite-canvas');
        #veil = document.getElementById('theme-veil');
        #months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
        #days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
        #today = new Date();
        #yearHeight = window.innerHeight;
        #activeYears = new Map();
        #isRendering = false;
        #tapCount = 0;

        constructor() {
          this.totalYears = 2000;
          this.startY = (this.totalYears / 2) * this.#yearHeight;
          this.#setupTheme();
          this.#setupCore();
          this.#setupEvents();
          this.#render();
        }

        #setupTheme() {
          const saved = localStorage.getItem('theme');
          const system = window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-theme', saved || (system ? 'dark' : 'light'));
        }

        #toggleTheme() {
          // Tahap 1: Kedipan Menutup (Fast In)
          this.#veil.classList.add('active');

          // Tahap 2: Ganti Realitas (Di balik layar)
          setTimeout(() => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);

            // Feedback taktil singkat
            if (navigator.vibrate) navigator.vibrate(15);

            // Tahap 3: Kedipan Terbuka (Slow Out - Cinematic)
            setTimeout(() => {
              this.#veil.classList.remove('active');
            }, 100);
          }, 200);
        }

        #setupCore() {
          this.#canvas.style.height = `${this.totalYears * this.#yearHeight}px`;
          this.#viewport.scrollTop = this.startY;
          this.observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((e) => {
                window.requestAnimationFrame(() => {
                  e.target.classList.toggle('active', e.isIntersecting);
                });
              });
            },
            { threshold: 0.1 }
          );
        }

        #setupEvents() {
          this.#viewport.addEventListener(
            'scroll',
            () => {
              if (!this.#isRendering) {
                window.requestAnimationFrame(() => {
                  this.#render();
                  this.#isRendering = false;
                });
                this.#isRendering = true;
              }
            },
            { passive: true }
          );

          // Keyboard: T atau D untuk Theme
          window.addEventListener('keydown', (e) => {
            if (['t', 'd'].includes(e.key.toLowerCase())) this.#toggleTheme();
            if (e.key === ' ') {
              e.preventDefault();
              this.jumpToToday();
            }
          });

          // Mobile: Triple Tap untuk Theme
          this.#viewport.addEventListener(
            'touchstart',
            () => {
              this.#tapCount++;
              setTimeout(() => {
                this.#tapCount = 0;
              }, 400);
              if (this.#tapCount === 3) this.#toggleTheme();
            },
            { passive: true }
          );

          window.addEventListener('resize', () => location.reload());
        }

        #render() {
          const scrollTop = this.#viewport.scrollTop;
          const idx = Math.round(scrollTop / this.#yearHeight);
          const year = this.#today.getFullYear() + (idx - this.totalYears / 2);
          for (let i = -1; i <= 1; i++) this.#drawYear(year + i, (idx + i) * this.#yearHeight);
          this.#activeYears.forEach((block, y) => {
            if (Math.abs(y - year) > 1) {
              this.observer.unobserve(block);
              block.remove();
              this.#activeYears.delete(y);
            }
          });
        }

        #drawYear(year, yPos) {
          if (this.#activeYears.has(year)) return;
          const block = document.createElement('section');
          block.className = 'year-block';
          block.style.top = `${yPos}px`;
          const firstDay = new Date(year, 0, 1).getDay();
          const totalDays = (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 366 : 365;
          const vw = window.innerWidth;
          let cols = Math.ceil(Math.sqrt(365 * (vw / window.innerHeight)));
          if (vw < 500) cols = Math.max(cols, 14);
          const rows = Math.ceil((totalDays + firstDay) / cols);

          let gridHTML = `<div class="grid-container"><div class="watermark-embedded">${year}</div><div class="grid-layer" style="grid-template-columns: repeat(${cols}, 1fr); grid-template-rows: repeat(${rows}, 1fr);">`;
          for (let s = 0; s < cols * rows; s++) {
            const date = new Date(year, 0, 1);
            date.setDate(date.getDate() + (s - firstDay));
            const isMain = date.getFullYear() === year;
            let cls = ['cell'];
            if (!isMain) cls.push('filler');
            else {
              if (date.getDate() === 1) cls.push('month-start');
              if (date.getDay() === 0 || date.getDay() === 6) cls.push('weekend');
              if (date.toDateString() === this.#today.toDateString()) cls.push('today');
            }
            gridHTML += `<div class="${cls.join(' ')}" style="--s-idx: ${
              s % 60
            }"><div class="cell-content"><span class="info-meta">${
              this.#months[date.getMonth()]
            }</span><span class="date-num">${date.getDate()}</span><span class="info-meta">${
              this.#days[date.getDay()]
            }</span></div></div>`;
          }
          block.innerHTML = gridHTML + `</div></div>`;
          this.#canvas.appendChild(block);
          this.#activeYears.set(year, block);
          this.observer.observe(block);
        }

        jumpToToday() {
          this.#viewport.style.scrollBehavior = 'auto';
          this.#viewport.scrollTop = this.startY;
          setTimeout(() => (this.#viewport.style.scrollBehavior = 'smooth'), 50);
        }
      }

      new GridArchitect();
    </script>
  </body>
</html>
